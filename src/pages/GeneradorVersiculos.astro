---
// GeneradorVersiculos.astro - Versi칩n App Compacta
---

<div class="min-h-screen bg-slate-100 py-6 px-4 font-sans">
    <div class="max-w-md mx-auto"> <header class="text-center mb-6">
            <h1 class="text-3xl font-serif italic text-slate-800">Postales del Cielo</h1>
            <p class="text-xs text-slate-500 uppercase tracking-widest font-bold">Dise침o para el alma</p>
        </header>

        <div class="relative mb-8 flex justify-center">
            <div class="w-full bg-white p-2 rounded-2xl shadow-xl border border-slate-200">
                <canvas 
                    id="mainCanvas" 
                    width="1080" 
                    height="1350" 
                    class="w-full h-auto rounded-xl shadow-inner block bg-slate-200">
                </canvas>
            </div>
            
            <button 
                id="btnRandom" 
                class="absolute -bottom-4 right-4 bg-slate-900 text-white p-3 rounded-full shadow-lg hover:scale-110 active:scale-95 transition-all">
                游댃
            </button>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 space-y-4">
            
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Vers칤culo</label>
                <textarea 
                    id="txtVersiculo" 
                    rows="3" 
                    class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-amber-500 focus:outline-none text-sm italic text-slate-700"
                    placeholder="Escribe la palabra aqu칤..."
                >Todo lo puedo en Cristo que me fortalece.</textarea>
            </div>

            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Cita</label>
                <input 
                    id="txtCita" 
                    type="text" 
                    class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-amber-500 focus:outline-none text-sm font-bold text-slate-700"
                    value="Filipenses 4:13"
                />
            </div>

            <div class="grid grid-cols-2 gap-3 pt-2">
                <button 
                    id="btnDownload" 
                    class="flex items-center justify-center gap-2 p-3 bg-amber-500 text-white rounded-xl font-bold text-sm shadow-md hover:bg-amber-600 transition-all active:scale-95">
                    拘勇 Guardar
                </button>
                <button 
                    id="btnShare" 
                    class="flex items-center justify-center gap-2 p-3 bg-slate-800 text-white rounded-xl font-bold text-sm shadow-md hover:bg-black transition-all active:scale-95">
                    游님 Enviar
                </button>
            </div>
        </div>

        <footer class="mt-8 text-center">
            <p class="text-[10px] text-slate-400 font-medium italic">"L치mpara es a mis pies tu palabra..."</p>
        </footer>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('txtVersiculo');
    const citaInput = document.getElementById('txtCita');
    
    const fondos = [
        'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=1080&h=1350&fit=crop'
    ];

    let bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.src = fondos[0];

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

        // Overlay cinematogr치fico
        const grad = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 100, canvas.width/2, canvas.height/2, 900);
        grad.addColorStop(0, 'rgba(0,0,0,0.2)');
        grad.addColorStop(1, 'rgba(0,0,0,0.7)');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Configuraci칩n de texto
        const margin = 120;
        const maxWidth = canvas.width - (margin * 2);
        let fontSize = 85;
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 20;

        const getLines = (fSize) => {
            ctx.font = `italic 700 ${fSize}px 'Playfair Display', serif`;
            let words = textInput.value.split(' ');
            let lines = [];
            let cLine = words[0];
            for (let i = 1; i < words.length; i++) {
                let test = cLine + " " + words[i];
                if (ctx.measureText(test).width > maxWidth) {
                    lines.push(cLine);
                    cLine = words[i];
                } else {
                    cLine = test;
                }
            }
            lines.push(cLine);
            return lines;
        };

        let lines = getLines(fontSize);
        while (lines.length * fontSize * 1.3 > 750 && fontSize > 40) {
            fontSize -= 5;
            lines = getLines(fontSize);
        }

        let startY = (canvas.height / 2) - ((lines.length - 1) * fontSize * 1.3 / 2) - 60;
        lines.forEach((l, i) => {
            ctx.fillText(l, canvas.width / 2, startY + (i * fontSize * 1.3));
        });

        // Adorno y Cita
        const lineY = startY + (lines.length * fontSize * 1.3) + 20;
        ctx.shadowBlur = 0;
        const goldGrad = ctx.createLinearGradient(canvas.width/2 - 150, 0, canvas.width/2 + 150, 0);
        goldGrad.addColorStop(0, 'transparent');
        goldGrad.addColorStop(0.5, '#D4AF37');
        goldGrad.addColorStop(1, 'transparent');
        ctx.fillStyle = goldGrad;
        ctx.fillRect(canvas.width/2 - 150, lineY, 300, 4);

        ctx.fillStyle = "#F3E5AB";
        ctx.font = "bold 50px Montserrat, sans-serif";
        ctx.fillText(citaInput.value.toUpperCase(), canvas.width / 2, lineY + 90);
        
        ctx.fillStyle = "rgba(255,255,255,0.4)";
        ctx.font = "24px Montserrat";
        ctx.fillText("Creado con Mi App Biblia", canvas.width / 2, canvas.height - 80);
    }

    bgImg.onload = draw;
    textInput.oninput = draw;
    citaInput.oninput = draw;
    
    document.getElementById('btnRandom').onclick = () => {
        bgImg.src = fondos[Math.floor(Math.random() * fondos.length)];
    };

    document.getElementById('btnDownload').onclick = () => {
        const link = document.createElement('a');
        link.download = 'versiculo.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
    };

    document.getElementById('btnShare').onclick = async () => {
        try {
            const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
            const file = new File([blob], 'bendicion.png', { type: 'image/png' });
            if (navigator.share) {
                await navigator.share({ files: [file], title: 'Palabra de Dios' });
            } else {
                alert("Usa el bot칩n guardar y comp치rtela desde tu galer칤a.");
            }
        } catch (e) { console.log("Error al compartir"); }
    };
</script>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,700&family=Montserrat:wght@400;700&display=swap');
    
    /* El truco para que se vea bien en celulares */
    canvas {
        width: 100% !important;
        height: auto !important;
        aspect-ratio: 4 / 5;
    }
</style>
