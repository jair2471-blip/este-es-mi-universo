---
// GeneradorVersiculos.astro - VersiÃ³n App de Bolsillo
---

<div class="flex items-center justify-center min-h-screen bg-slate-200 p-4">
    <div class="w-full max-w-[380px] bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-[8px] border-slate-900 flex flex-col">
        
        <div class="p-6 space-y-4 flex-1">
            <header class="text-center pt-2">
                <h2 class="text-2xl font-serif italic text-slate-800">Postales del Cielo</h2>
                <div class="h-1 w-10 bg-amber-500 mx-auto rounded-full mt-1"></div>
            </header>

            <div class="relative w-full max-h-[350px] overflow-hidden rounded-2xl shadow-lg border border-slate-100">
                <canvas 
                    id="mainCanvas" 
                    width="1080" 
                    height="1350" 
                    class="w-full h-full object-contain block bg-slate-100">
                </canvas>
                
                <button 
                    id="btnRandom" 
                    class="absolute bottom-3 right-3 bg-white/90 backdrop-blur p-2 rounded-full shadow-md hover:bg-amber-500 hover:text-white transition-all active:scale-90">
                    ðŸ”„
                </button>
            </div>

            <div class="space-y-3">
                <div class="group">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">VersÃ­culo</label>
                    <textarea 
                        id="txtVersiculo" 
                        rows="2" 
                        class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-amber-500 focus:outline-none text-xs italic text-slate-700 resize-none shadow-sm"
                    >Todo lo puedo en Cristo que me fortalece.</textarea>
                </div>

                <div>
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Referencia</label>
                    <input 
                        id="txtCita" 
                        type="text" 
                        class="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-amber-500 focus:outline-none text-xs font-bold text-slate-700 shadow-sm"
                        value="Filipenses 4:13"
                    />
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button id="btnDownload" class="bg-amber-500 text-white py-3 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">
                        ðŸ’¾ GUARDAR
                    </button>
                    <button id="btnShare" class="bg-slate-800 text-white py-3 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">
                        ðŸ“± ENVIAR
                    </button>
                </div>
            </div>
        </div>

        <div class="h-6 w-full flex justify-center items-center pb-2">
            <div class="w-24 h-1 bg-slate-200 rounded-full"></div>
        </div>
    </div>
</div>

<script>
    // ... El script se mantiene igual que antes ...
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('txtVersiculo');
    const citaInput = document.getElementById('txtCita');
    
    const fondos = [
        'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=1080&h=1350&fit=crop'
    ];

    let bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.src = fondos[0];

    function draw() {
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const margin = 100;
        const maxWidth = canvas.width - (margin * 2);
        let fontSize = 90;
        
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "rgba(0,0,0,0.7)";
        ctx.shadowBlur = 20;

        const getLines = (fSize) => {
            ctx.font = `italic 700 ${fSize}px 'Georgia', serif`;
            let words = textInput.value.split(' ');
            let lines = [];
            let cLine = words[0];
            for (let i = 1; i < words.length; i++) {
                let test = cLine + " " + words[i];
                if (ctx.measureText(test).width > maxWidth) {
                    lines.push(cLine);
                    cLine = words[i];
                } else {
                    cLine = test;
                }
            }
            lines.push(cLine);
            return lines;
        };

        let lines = getLines(fontSize);
        while (lines.length * fontSize * 1.4 > 800) {
            fontSize -= 5;
            lines = getLines(fontSize);
        }

        let startY = (canvas.height / 2) - ((lines.length - 1) * fontSize * 1.4 / 2);
        lines.forEach((l, i) => {
            ctx.fillText(l, canvas.width / 2, startY + (i * fontSize * 1.4));
        });

        ctx.font = "bold 55px 'Arial', sans-serif";
        ctx.fillStyle = "#FFD700";
        ctx.fillText(citaInput.value.toUpperCase(), canvas.width / 2, startY + (lines.length * fontSize * 1.4) + 80);
    }

    bgImg.onload = draw;
    textInput.oninput = draw;
    citaInput.oninput = draw;
    
    document.getElementById('btnRandom').onclick = () => {
        bgImg.src = fondos[Math.floor(Math.random() * fondos.length)];
    };

    document.getElementById('btnDownload').onclick = () => {
        const link = document.createElement('a');
        link.download = 'bendicion.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    };

    document.getElementById('btnShare').onclick = async () => {
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
        const file = new File([blob], 'bendicion.png', { type: 'image/png' });
        if (navigator.share) navigator.share({ files: [file] });
    };
</script>

<style>
    /* El canvas se adapta al ancho del celular pero mantiene su resoluciÃ³n */
    canvas {
        max-width: 100% !important;
        height: auto !important;
        aspect-ratio: 4 / 5;
    }
</style>
