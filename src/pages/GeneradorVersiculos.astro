---
// GeneradorVersiculos.astro - Versión Anti-Gigante
---

<div style="text-align:center; padding:20px;">
  <h2>Generador de Imagen - Versículos</h2>

  <input type="file" id="imagenInput" accept="image/*" />
  <br /><br />

  <textarea 
    id="textoInput" 
    placeholder="Escribe aquí el versículo..." 
    rows="4" 
    style="width:80%; padding:10px;">
  </textarea>

  <br /><br />

  <button id="generarBtn" style="padding:10px 20px; cursor:pointer;">
    Generar Imagen
  </button>

  <br /><br />

  <canvas id="versiculoCanvas" width="800" height="800" 
    style="border:1px solid #ccc;">
  </canvas>

  <br /><br />

  <button id="descargarBtn" style="padding:10px 20px; cursor:pointer;">
    Descargar Imagen
  </button>
</div>

<script>

document.addEventListener("DOMContentLoaded", function () {

  const imagenInput = document.getElementById("imagenInput");
  const textoInput = document.getElementById("textoInput");
  const generarBtn = document.getElementById("generarBtn");
  const descargarBtn = document.getElementById("descargarBtn");
  const canvas = document.getElementById("versiculoCanvas");

  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  const img = new Image();

  // Ajustar texto en múltiples líneas
  function wrapText(context, text, maxWidth, lineHeight, x, y) {
    const words = text.split(" ");
    let line = "";
    let lines = [];

    for (let n = 0; n < words.length; n++) {
      const testLine = line + words[n] + " ";
      const metrics = context.measureText(testLine);
      const testWidth = metrics.width;

      if (testWidth > maxWidth && n > 0) {
        lines.push(line);
        line = words[n] + " ";
      } else {
        line = testLine;
      }
    }

    lines.push(line);

    for (let i = 0; i < lines.length; i++) {
      context.fillText(lines[i], x, y + (i * lineHeight));
    }
  }

  generarBtn.addEventListener("click", function () {

    if (!imagenInput.files || imagenInput.files.length === 0) {
      alert("Selecciona una imagen primero.");
      return;
    }

    const reader = new FileReader();

    reader.onload = function (e) {

      img.onload = function () {

        // Dibujar imagen base
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Capa oscura para que el texto se vea mejor
        ctx.fillStyle = "rgba(0, 0, 0, 0.4)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Estilo del texto
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.font = "40px Playfair Display";

        const texto = textoInput.value;
        const maxWidth = canvas.width - 100;
        const lineHeight = 50;
        const x = canvas.width / 2;
        const y = canvas.height / 2;

        wrapText(ctx, texto, maxWidth, lineHeight, x, y);
      };

      img.src = e.target.result;
    };

    reader.readAsDataURL(imagenInput.files[0]);
  });

  descargarBtn.addEventListener("click", function () {
    const link = document.createElement("a");
    link.download = "versiculo.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });

});

</script>

