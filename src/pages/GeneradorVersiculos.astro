---
// GeneradorVersiculos.astro - Versi√≥n Integrada
---

<div class="flex flex-col items-center justify-center min-h-screen bg-gray-50 py-10 px-4">
    <div class="w-full max-w-md space-y-6">
        
        <div class="text-center">
            <h2 class="text-4xl font-serif italic text-gray-800">Postales del Cielo</h2>
            <p class="text-[10px] uppercase tracking-[0.2em] font-bold text-amber-600 mt-2">Generador de Bendiciones</p>
        </div>

        <div class="relative group shadow-2xl rounded-2xl overflow-hidden border-4 border-white bg-white">
            <canvas 
                id="mainCanvas" 
                width="1080" 
                height="1350" 
                class="w-full h-auto block shadow-inner transition-transform duration-500 group-hover:scale-[1.01]">
            </canvas>
            
            <button 
                id="btnRandom" 
                title="Cambiar fondo"
                class="absolute bottom-4 right-4 bg-white/90 backdrop-blur text-gray-800 p-3 rounded-full shadow-lg hover:bg-amber-500 hover:text-white transition-all active:scale-90 border border-gray-100">
                üîÑ
            </button>
        </div>

        <div class="bg-white/80 backdrop-blur-md p-6 rounded-3xl shadow-xl space-y-4 border border-white">
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider ml-1">Tu Vers√≠culo</label>
                <textarea 
                    id="txtVersiculo" 
                    rows="3" 
                    class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-amber-500 text-sm italic text-gray-700 shadow-inner"
                >Todo lo puedo en Cristo que me fortalece.</textarea>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider ml-1">Referencia</label>
                <input 
                    id="txtCita" 
                    type="text" 
                    class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-amber-500 text-sm font-bold text-gray-700 shadow-inner"
                    value="Filipenses 4:13"
                />
            </div>

            <div class="grid grid-cols-2 gap-4 pt-2">
                <button id="btnDownload" class="bg-amber-500 text-white p-4 rounded-2xl font-bold text-sm shadow-lg shadow-amber-200 hover:bg-amber-600 active:scale-95 transition-all">
                    ‚¨áÔ∏è Descargar
                </button>
                <button id="btnShare" class="bg-gray-900 text-white p-4 rounded-2xl font-bold text-sm shadow-lg shadow-gray-300 hover:bg-black active:scale-95 transition-all">
                    üì± Compartir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const textInput = document.getElementById('txtVersiculo');
    const citaInput = document.getElementById('txtCita');
    
    const fondos = [
        'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1501854140801-50d01698950b?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?w=1080&h=1350&fit=crop',
        'https://images.unsplash.com/photo-1475924156734-496f6cac6ec1?w=1080&h=1350&fit=crop'
    ];

    let bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.src = fondos[0];

    function draw() {
        if (!ctx) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

        // Capa de contraste
        ctx.fillStyle = 'rgba(0,0,0,0.45)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const margin = 120;
        const maxWidth = canvas.width - (margin * 2);
        let fontSize = 80;
        
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 15;

        const getLines = (fSize) => {
            ctx.font = `italic 600 ${fSize}px 'Georgia', serif`;
            let words = textInput.value.split(' ');
            let lines = [];
            let cLine = words[0];
            for (let i = 1; i < words.length; i++) {
                let test = cLine + " " + words[i];
                if (ctx.measureText(test).width > maxWidth) {
                    lines.push(cLine);
                    cLine = words[i];
                } else {
                    cLine = test;
                }
            }
            lines.push(cLine);
            return lines;
        };

        let lines = getLines(fontSize);
        while (lines.length * fontSize * 1.4 > 800) {
            fontSize -= 5;
            lines = getLines(fontSize);
        }

        let startY = (canvas.height / 2) - ((lines.length - 1) * fontSize * 1.4 / 2);
        lines.forEach((l, i) => {
            ctx.fillText(l, canvas.width / 2, startY + (i * fontSize * 1.4));
        });

        // Cita
        ctx.font = "bold 45px 'Arial', sans-serif";
        ctx.fillStyle = "#FFD700";
        ctx.fillText(citaInput.value.toUpperCase(), canvas.width / 2, startY + (lines.length * fontSize * 1.4) + 60);
    }

    bgImg.onload = draw;
    textInput.oninput = draw;
    citaInput.oninput = draw;
    
    document.getElementById('btnRandom').onclick = () => {
        bgImg.src = fondos[Math.floor(Math.random() * fondos.length)];
    };

    document.getElementById('btnDownload').onclick = () => {
        const link = document.createElement('a');
        link.download = 'versiculo-bendicion.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    };

    document.getElementById('btnShare').onclick = async () => {
        const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
        const file = new File([blob], 'bendicion.png', { type: 'image/png' });
        if (navigator.share) navigator.share({ files: [file] });
    };
</script>

<style>
    /* El canvas se adapta al ancho del celular pero mantiene su resoluci√≥n */
    canvas {
        max-width: 100% !important;
        height: auto !important;
        aspect-ratio: 4 / 5;
    }
</style>
