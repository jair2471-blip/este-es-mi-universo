---
import Layout from '~/layouts/PageLayout.astro';

const metadata = { title: 'ANTONOV' };

const ESTADOS = [
  'CANSANCIO','SOLEDAD','ANSIEDAD','DUDA','RUPTURA','MIEDO',
  'RABIA','VACÍO','NOSTALGIA','CONFUSIÓN','TRISTEZA','CULPA',
  'AGOBIO','BLOQUEO','FRUSTRACIÓN','INSEGURIDAD'
];
---

<Layout metadata={metadata}>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=JetBrains+Mono:wght@700&display=swap');

    .antonov-app {
      display: grid;
      grid-template-columns: 350px 1fr;
      background: #000;
      color: #fff;
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
    }

    /* Forzar que el layout de Astro no nos encierre */
    :global(main) { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }

    .sidebar {
      background: #0a0a0a;
      border-right: 1px solid #222;
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    h1 { font-size: 2.5rem; font-weight: 900; margin: 0; }
    .tag { font-family: 'JetBrains Mono'; color: #ffd700; font-size: 10px; letter-spacing: 2px; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn-state {
      background: #111;
      border: 1px solid #222;
      color: #888;
      padding: 12px;
      font-family: 'JetBrains Mono';
      font-size: 10px;
      cursor: pointer;
      text-transform: uppercase;
    }

    .btn-state.active { background: #fff; color: #000; border-color: #fff; font-weight: bold; }

    .canvas-container {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #050505;
      padding: 40px;
    }

    canvas {
      max-width: 100%;
      max-height: 80vh;
      border: 1px solid #222;
      background: #000;
    }

    .controls { border-top: 1px solid #222; padding-top: 20px; }
    .btn-main {
      width: 100%;
      padding: 20px;
      background: #fff;
      color: #000;
      font-weight: 900;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>

  <div class="antonov-app">
    <aside class="sidebar">
      <div>
        <h1>ANTONOV</h1>
        <div class="tag">PROTOCOLO DE VERDAD</div>
      </div>

      <div class="states-section">
        <p style="font-size: 10px; color: #666; margin-bottom: 10px;">SELECCIONA UN ESTADO</p>
        <div class="grid">
          {ESTADOS.map((estado) => (
            <button class="btn-state" data-state={estado}>{estado}</button>
          ))}
        </div>
      </div>

      <div class="controls">
        <input type="range" id="slider" min="40" max="150" value="85" style="width: 100%;">
        <button id="btn-traducir" class="btn-main">TRADUCIR ESTADO</button>
      </div>
    </aside>

    <main class="canvas-container">
      <canvas id="mainCanvas"></canvas>
    </main>
  </div>

  <script is:inline>
    function initApp() {
      const canvas = document.getElementById('mainCanvas');
      const ctx = canvas.getContext('2d');
      const buttons = document.querySelectorAll('.btn-state');
      const btnTraducir = document.getElementById('btn-traducir');
      const slider = document.getElementById('slider');

      let selectedState = "";
      let currentText = "SELECCIONA UN ESTADO";

      function draw() {
        canvas.width = 1080;
        canvas.height = 1080;
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, 1080, 1080);

        // Estado arriba
        ctx.fillStyle = "#ffd700";
        ctx.font = "700 30px 'JetBrains Mono'";
        if (selectedState) ctx.fillText(`> ${selectedState}`, 80, 100);

        // Texto central
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        const fontSize = slider.value;
        ctx.font = `900 ${fontSize}px Inter`;
        
        // Wrap simple
        const words = currentText.split(' ');
        let y = 540;
        words.forEach((word, i) => {
            ctx.fillText(word, 540, y + (i * fontSize));
        });
      }

      buttons.forEach(btn => {
        btn.onclick = () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedState = btn.getAttribute('data-state');
          draw();
        };
      });

      slider.oninput = draw;

      btnTraducir.onclick = async () => {
        if(!selectedState) return;
        btnTraducir.innerText = "PROCESANDO...";
        try {
          const r = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
            method: 'POST',
            body: JSON.stringify({ prompt: `ESTADO: ${selectedState}. UNA FRASE CORTA.` })
          });
          const d = await r.json();
          currentText = d.text || "ERROR";
        } catch(e) {
          currentText = "SIN CONEXIÓN";
        }
        btnTraducir.innerText = "TRADUCIR ESTADO";
        draw();
      };

      draw();
    }

    // Ejecutar al cargar
    window.onload = initApp;
    document.addEventListener('astro:after-swap', initApp);
  </script>
</Layout>
