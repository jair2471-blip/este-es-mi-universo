---
import Layout from '~/layouts/PageLayout.astro';

const metadata = { title: 'ANTONOV | PROTOCOLO' };

const ESTADOS = [
  'CANSANCIO','SOLEDAD','ANSIEDAD','DUDA','RUPTURA','MIEDO',
  'RABIA','VAC√çO','NOSTALGIA','CONFUSI√ìN','TRISTEZA','CULPA',
  'AGOBIO','BLOQUEO','FRUSTRACI√ìN','INSEGURIDAD'
];
---

<Layout metadata={metadata}>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=JetBrains+Mono:wght@700&display=swap');

    /* Reset para ocupar toda la pantalla sin m√°rgenes del layout */
    :global(main) { max-width: 100% !important; padding: 0 !important; margin: 0 !important; }

    .antonov-app {
      display: grid;
      grid-template-columns: 380px 1fr;
      background: #000;
      color: #fff;
      height: 100vh;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
    }

    .sidebar {
      background: #0a0a0a;
      border-right: 1px solid #222;
      display: flex;
      flex-direction: column;
      padding: 0;
    }

    .header-box {
      padding: 40px 30px;
      border-bottom: 1px solid #222;
    }

    h1 { font-size: 2.8rem; font-weight: 900; margin: 0; letter-spacing: -2px; }
    .tag { font-family: 'JetBrains Mono'; color: #ffd700; font-size: 10px; letter-spacing: 3px; }

    .states-container {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .btn-state {
      background: #111;
      border: 1px solid #222;
      color: #666;
      padding: 14px 10px;
      font-family: 'JetBrains Mono';
      font-size: 10px;
      cursor: pointer;
      text-transform: uppercase;
      transition: all 0.2s;
    }

    .btn-state:hover { border-color: #ffd700; color: #fff; }
    .btn-state.active { background: #ffd700; color: #000; border-color: #ffd700; font-weight: 700; }

    .controls-box {
      padding: 30px;
      border-top: 1px solid #222;
      background: #050505;
    }

    .btn-main {
      width: 100%;
      padding: 22px;
      background: #fff;
      color: #000;
      font-weight: 900;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: 0.3s;
    }

    .btn-main:hover { background: #ffd700; transform: scale(1.02); }
    .btn-main:disabled { opacity: 0.2; cursor: not-allowed; }

    .canvas-area {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      padding: 40px;
      position: relative;
    }

    canvas {
      max-width: 100%;
      max-height: 90vh;
      border: 1px solid #1a1a1a;
      box-shadow: 0 0 60px rgba(0,0,0,1);
    }

    /* Scrollbar minimalista */
    .states-container::-webkit-scrollbar { width: 4px; }
    .states-container::-webkit-scrollbar-thumb { background: #222; }
  </style>

  <div class="antonov-app">
    <aside class="sidebar">
      <div class="header-box">
        <h1>ANTONOV</h1>
        <div class="tag">PROTOCOLO DE VERDAD</div>
      </div>

      <div class="states-container">
        <p style="font-size: 10px; color: #444; margin-bottom: 15px; letter-spacing: 1px;">SELECCIONA TU ESTADO ACTUAL</p>
        <div class="grid">
          {ESTADOS.map((e) => (
            <button class="btn-state" data-state={e}>{e}</button>
          ))}
        </div>
      </div>

      <div class="controls-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px">
            <span class="tag" style="color:#444">TAMA√ëO</span>
            <span id="sizeVal" class="tag">85PX</span>
        </div>
        <input type="range" id="slider" min="50" max="180" value="90" style="width:100%; accent-color:#ffd700">
        <button id="btn-traducir" class="btn-main">TRADUCIR ESTADO</button>
      </div>
    </aside>

    <div class="canvas-area">
      <canvas id="mainCanvas"></canvas>
    </div>
  </div>

  <script is:inline>
  async function startAntonov() {
    const canvas = document.getElementById('mainCanvas');
    if (!canvas) {
      console.error("No encontr√© el canvas, compa üò≠");
      return;
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
      console.error("getContext('2d') devolvi√≥ null. Revisa si el canvas est√° en el DOM.");
      return;
    }

    // Esperamos que las fuentes est√©n listas (s√∫per importante para canvas)
    await document.fonts.ready;

    const buttons = document.querySelectorAll('.btn-state');
    const btnTraducir = document.getElementById('btn-traducir');
    const slider = document.getElementById('slider');
    const sizeVal = document.getElementById('sizeVal');

    let selectedState = "";
    let currentText = "EL SILENCIO ES LA √öNICA RESPUESTA";

    function draw() {
      canvas.width = 1080;
      canvas.height = 1080;
      
      ctx.fillStyle = "#000";
      ctx.fillRect(0, 0, 1080, 1080);

      // Grano (queda brutal)
      for (let i = 0; i < 600; i++) {
        ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.04})`;
        ctx.fillRect(Math.random() * 1080, Math.random() * 1080, 2, 2);
      }

      if (selectedState) {
        ctx.fillStyle = "#ffd700";
        ctx.font = "700 30px 'JetBrains Mono', monospace"; // fallback por si no carga
        ctx.textAlign = "left";
        ctx.fillText(`// ANALIZANDO: ${selectedState}`, 80, 100);
        ctx.fillRect(80, 115, 200, 2);
      }

      ctx.fillStyle = "#fff";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      const fSize = parseInt(slider.value) || 85;
      ctx.font = `900 ${fSize}px 'Inter', sans-serif`; // fallback sans-serif

      const words = currentText.toUpperCase().split(' ');
      const spacing = fSize * 0.92;
      const totalH = words.length * spacing;
      let startY = 540 - (totalH / 2) + (spacing / 2);

      words.forEach((word, i) => {
        ctx.shadowColor = "rgba(255,255,255,0.15)";
        ctx.shadowBlur = 25;
        ctx.fillText(word, 540, startY + (i * spacing));
      });
    }

    buttons.forEach(btn => {
      btn.onclick = () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedState = btn.dataset.state;
        draw();
      };
    });

    slider.oninput = () => {
      sizeVal.innerText = `${slider.value}PX`;
      draw();
    };

    btnTraducir.onclick = async () => {
      if (!selectedState) {
        alert("Primero escoge un estado, parce");
        return;
      }
      btnTraducir.disabled = true;
      btnTraducir.innerText = "EXTRAYENDO VERDAD...";

      try {
        const r = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: `ACT√öA COMO UN OR√ÅCULO BRUTALISTA. ESTADO: ${selectedState}. ESCRIBE UNA SENTENCIA DE M√ÅXIMO 8 PALABRAS QUE SEA UN GOLPE DE REALIDAD. SIN PIEDAD. TODO MAY√öSCULAS.`
          })
        });

        if (!r.ok) throw new Error("El worker se puso mam√≥n");

        const d = await r.json();
        currentText = d.text?.trim() || "EL VAC√çO NO RESPONDE";
      } catch (e) {
        console.error(e);
        currentText = "ERROR DE CONEXI√ìN";
      }

      btnTraducir.disabled = false;
      btnTraducir.innerText = "TRADUCIR ESTADO";
      draw();
    };

    // Primer dibujo (con fuentes ya listas)
    draw();
  }

  // Mejor timing en Astro
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    startAntonov();
  } else {
    window.addEventListener('load', startAntonov);
  }
  document.addEventListener('astro:after-swap', startAntonov);
</script>
</Layout>
