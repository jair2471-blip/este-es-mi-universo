---
import Layout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'ANTONOV | EL NÚCLEO',
};
---

<Layout metadata={metadata}>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=JetBrains+Mono:wght@700&display=swap');

    :global(main) { width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }

    .master-wrapper {
      width: 100%;
      height: 100vh;
      background: #050505;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: 'Inter', sans-serif;
    }

    .app-container {
      display: grid;
      grid-template-columns: 350px 1fr;
      width: 90%;
      max-width: 1200px;
      height: 80vh;
      border: 1px solid #333;
      background: #000;
    }

    .sidebar {
      padding: 30px;
      border-right: 1px solid #333;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .canvas-area {
      background: #080808;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    #mainCanvas {
      background: #000;
      max-width: 100%;
      max-height: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
      border: 1px solid #222;
    }

    textarea {
      width: 100%;
      height: 100px;
      background: #111;
      border: 1px solid #444;
      color: white;
      padding: 10px;
      font-family: 'JetBrains Mono', monospace;
    }

    .btn {
      background: white;
      color: black;
      padding: 15px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
    }

    .btn:hover { background: #ffd700; }
  </style>

  <div class="master-wrapper">
    <div class="app-container">
      <aside class="sidebar">
        <h2 style="margin:0; font-size: 2rem;">ANTONOV</h2>
        <p style="font-size: 0.7rem; color: #ffd700; letter-spacing: 2px;">V.6.0_STABLE</p>
        
        <div style="margin-top: 20px;">
          <label style="font-size: 0.6rem; color: #666; display:block; margin-bottom:5px;">PENSAMIENTO</label>
          <textarea id="userInput" placeholder="Escribe aquí..."></textarea>
        </div>

        <div style="margin-top: 10px;">
          <label style="font-size: 0.6rem; color: #666; display:block; margin-bottom:5px;">ZOOM TEXTO</label>
          <input type="range" id="sizeSlider" min="40" max="120" value="70" style="width:100%;">
        </div>

        <button id="generateBtn" class="btn">ANALIZAR</button>
      </aside>

      <main class="canvas-area">
        <canvas id="mainCanvas"></canvas>
      </main>
    </div>
  </div>

  <script is:inline>
    // USAMOS UNA FUNCIÓN DE AUTO-EJECUCIÓN PARA ASEGURARNOS QUE CORRE
    (function() {
      const init = () => {
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas?.getContext('2d');
        const btn = document.getElementById('generateBtn');
        const input = document.getElementById('userInput');
        const slider = document.getElementById('sizeSlider');

        if (!canvas || !ctx) return;

        let text = "SISTEMA LISTO PARA DECODIFICAR";
        let question = "";

        const draw = () => {
          // Resolución fija para que no se vea borroso
          canvas.width = 1000;
          canvas.height = 1000;

          // Fondo
          ctx.fillStyle = '#000000';
          ctx.fillRect(0, 0, 1000, 1000);

          // Grid
          ctx.strokeStyle = '#111';
          for(let i=0; i<1000; i+=100) {
            ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,1000); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(1000,i); ctx.stroke();
          }

          // Pregunta arriba
          if(question) {
            ctx.font = "bold 20px 'JetBrains Mono'";
            ctx.fillStyle = "#ffd700";
            ctx.textAlign = "left";
            ctx.fillText("> " + question.toUpperCase(), 50, 70);
          }

          // Respuesta centro
          const fontSize = parseInt(slider.value);
          ctx.font = `900 ${fontSize}px 'Inter'`;
          ctx.fillStyle = "white";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";

          // Ajuste de líneas simple
          const words = text.toUpperCase().split(' ');
          let lines = [], line = '';
          words.forEach(w => {
            if(ctx.measureText(line + w).width < 800) line += w + ' ';
            else { lines.push(line); line = w + ' '; }
          });
          lines.push(line);

          lines.forEach((l, i) => {
            ctx.fillText(l.trim(), 500, 500 - ((lines.length-1) * fontSize/2) + (i * fontSize * 1.2));
          });

          // Firma fija
          ctx.font = "bold 20px 'JetBrains Mono'";
          ctx.fillStyle = "#ffd700";
          ctx.textAlign = "center";
          ctx.fillText("ANTONOV // PROTOCOLO DE VERDAD", 500, 930);
        };

        btn.onclick = async () => {
          const val = input.value.trim();
          if(!val) return;
          
          btn.innerText = "PENSANDO...";
          question = val;

          try {
            const res = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
              method: 'POST',
              body: JSON.stringify({ prompt: `Antonov, mentor. Usuario dice: "${val}". Responde verdad cruda max 12 palabras. TODO MAYÚSCULAS.` })
            });
            const data = await res.json();
            text = data.text;
          } catch(e) {
            text = "ERROR DE CONEXIÓN";
          } finally {
            btn.innerText = "ANALIZAR";
            draw();
          }
        };

        slider.oninput = draw;
        draw();
      };

      // Correr al cargar y al navegar en Astro
      window.onload = init;
      document.addEventListener('astro:page-load', init);
    })();
  </script>
</Layout>
