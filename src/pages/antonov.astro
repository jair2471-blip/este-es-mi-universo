---
import Layout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'ANTONOV PRO | Elite Mindset',
  description: 'La conciencia artificial de los líderes.',
};
---

<Layout metadata={metadata}>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700&display=swap');

    * { box-sizing: border-box; margin: 0; padding: 0; }

    .stage {
      min-height: 100vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .brand {
      text-align: center;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 215, 0, 0.2);
    }

    .brand h1 {
      font-family: 'Arial Black', cursive;
      font-size: 3.5rem;
      color: #fff;
      letter-spacing: 3px;
      text-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
    }

    .brand p {
      color: #ffd700;
      font-size: 0.7rem;
      letter-spacing: 3px;
      font-weight: 700;
      margin-top: 8px;
    }

    .canvas-area {
      background: #000;
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 12px;
      padding: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
    }

    .controls {
      background: linear-gradient(135deg, #0a0a0a, #0d0d0d);
      border: 1px solid rgba(255, 215, 0, 0.15);
      border-radius: 12px;
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .input-group label {
      color: #888;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
    }

    textarea {
      background: #0a0a0a;
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 8px;
      color: #fff;
      padding: 14px;
      font-size: 0.95rem;
      font-family: 'Inter', sans-serif;
      resize: none;
      transition: all 0.3s ease;
    }

    textarea:focus {
      outline: none;
      border-color: rgba(255, 215, 0, 0.5);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.15);
    }

    .toolbar {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: center;
    }

    select {
      background: #0a0a0a;
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 8px;
      color: #fff;
      padding: 12px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    select:focus {
      outline: none;
      border-color: rgba(255, 215, 0, 0.5);
    }

    .size-control {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #0a0a0a;
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 8px;
      padding: 8px 15px;
    }

    .size-control span {
      color: #888;
      font-size: 0.75rem;
      font-weight: 700;
      min-width: 30px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      background: rgba(255, 215, 0, 0.2);
      height: 4px;
      border-radius: 2px;
      outline: none;
      flex: 1;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #ffd700;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
    }

    .actions {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
    }

    button {
      background: linear-gradient(135deg, #fff, #f0f0f0);
      color: #000;
      border: none;
      padding: 14px 20px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    .btn-generate {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      font-weight: 900;
      font-size: 0.9rem;
    }

    .btn-generate:hover:not(:disabled) {
      background: linear-gradient(135deg, #ffed4e, #ffd700);
    }

    #variant {
      grid-column: 1 / -1;
      font-size: 0.75rem;
    }

    @media (max-width: 768px) {
      .brand h1 {
        font-size: 2.5rem;
      }
      
      .toolbar {
        grid-template-columns: 1fr;
      }
      
      .actions {
        grid-template-columns: 1fr;
      }
      
      .btn-generate {
        grid-column: 1;
      }
      
      .canvas-area {
        padding: 15px;
      }
    }
  </style>

  <div class="stage">
    <div class="container">
      <div class="brand">
        <h1>ANTONOV</h1>
        <p>SISTEMA DE EXCELENCIA</p>
      </div>

      <div class="canvas-area">
        <canvas id="canvas"></canvas>
      </div>

      <div class="controls">
        <div class="input-group">
          <label>Tu situación</label>
          <textarea id="input" rows="2" placeholder="Escribe lo que te detiene..."></textarea>
        </div>

        <div class="toolbar">
          <select id="format">
            <option value="post">Cuadrado (Feed)</option>
            <option value="story">Vertical (Story)</option>
          </select>

          <div class="size-control">
            <span id="size-label">100</span>
            <input type="range" id="size" min="50" max="150" value="100">
          </div>
        </div>

        <div class="actions">
          <button id="generate" class="btn-generate">Generar Sentencia</button>
          <button id="variant" style="display:none; background: linear-gradient(135deg, #888, #666);">Nueva Variación</button>
          <button id="share">Compartir</button>
          <button id="download">Descargar</button>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    function init() {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      const el = {
        input: document.getElementById('input'),
        format: document.getElementById('format'),
        size: document.getElementById('size'),
        sizeLabel: document.getElementById('size-label'),
        generate: document.getElementById('generate'),
        variant: document.getElementById('variant'),
        share: document.getElementById('share'),
        download: document.getElementById('download')
      };

      let currentText = '';
      let lastPrompt = '';

      function wrapText(context, text, x, y, maxW, lineH, centerV) {
        const words = text.split(' ');
        let lines = [];
        let line = '';
        
        words.forEach(word => {
          const test = line + word + ' ';
          if (context.measureText(test).width > maxW && line.length > 0) {
            lines.push(line);
            line = word + ' ';
          } else {
            line = test;
          }
        });
        lines.push(line);

        let startY = centerV ? y - ((lines.length - 1) * lineH) / 2 : y;
        
        lines.forEach(l => {
          context.fillText(l.trim(), x, startY);
          startY += lineH;
        });
      }

      function render() {
        const isStory = el.format.value === 'story';
        const w = 1080;
        const h = isStory ? 1920 : 1080;
        
        canvas.width = w;
        canvas.height = h;

        // Fondo
        const grad = ctx.createLinearGradient(0, 0, 0, h);
        grad.addColorStop(0, '#000');
        grad.addColorStop(0.5, '#0a0a0a');
        grad.addColorStop(1, '#000');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, w, h);

        // Pregunta/situación arriba
        if (el.input.value.trim()) {
          const questionSize = w < 600 ? 20 : 30; // Más pequeño en móvil
          ctx.font = `italic 600 ${questionSize}px 'Inter'`;
          ctx.fillStyle = "rgba(255,255,255,0.35)";
          ctx.textAlign = "center";
          ctx.shadowColor = 'rgba(255, 215, 0, 0.3)';
          ctx.shadowBlur = 20;
          const questionY = w < 600 ? 80 : 120;
          const questionLineHeight = w < 600 ? 32 : 45;
          wrapText(ctx, el.input.value.toUpperCase(), w/2, questionY, w*0.85, questionLineHeight, false);
          ctx.shadowBlur = 0;
        }

        // Texto principal
        const text = (currentText || 'ESPERANDO SENTENCIA...').toUpperCase();
        const fSize = parseInt(el.size.value);
        
        ctx.font = `900 ${fSize}px 'Bebas Neue'`;
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(255, 215, 0, 0.4)';
        ctx.shadowBlur = 30;
        
        wrapText(ctx, text, w/2, h/2, w*0.85, fSize * 1.3, true);
        
        ctx.shadowBlur = 0;

        // Firma
        const brandSize = w < 600 ? 18 : 22;
        ctx.font = `700 ${brandSize}px 'Inter'`;
        const brandGrad = ctx.createLinearGradient(0, h - 70, w, h - 70);
        brandGrad.addColorStop(0, '#ffd700');
        brandGrad.addColorStop(0.5, '#ffed4e');
        brandGrad.addColorStop(1, '#ffd700');
        ctx.fillStyle = brandGrad;
        ctx.shadowColor = 'rgba(255, 215, 0, 0.6)';
        ctx.shadowBlur = 15;
        const brandY = w < 600 ? h - 50 : h - 70;
        ctx.fillText('EL UNIVERSO DE LA MENTE', w/2, brandY);
        ctx.shadowBlur = 0;
      }

      async function generateSentence() {
        if (!el.input.value.trim()) {
          alert('Escribe algo primero, líder.');
          return;
        }

        const isVariant = lastPrompt === el.input.value;
        const btn = isVariant ? el.variant : el.generate;
        
        btn.textContent = 'Generando...';
        btn.disabled = true;

        try {
          lastPrompt = el.input.value;
          
          const res = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: `Eres Antonov (Estilo Miguel Ángel Cornejo). Contexto: "${el.input.value}". Responde con 2 FRASES CORTAS Y MATONAS en MAYÚSCULAS. Sé berraco y directo. ${isVariant ? 'Da una versión diferente a la anterior.' : ''}`
            })
          });
          
          const data = await res.json();
          currentText = data.text.replace(/\*\*/g, '');
          render();
          
          // Mostrar botón de variación
          el.variant.style.display = 'block';
        } catch (e) {
          alert('Error al generar. Intenta de nuevo.');
        } finally {
          btn.textContent = isVariant ? 'Nueva Variación' : 'Generar Sentencia';
          btn.disabled = false;
        }
      }

      el.generate.onclick = generateSentence;
      el.variant.onclick = generateSentence;

      el.download.onclick = () => {
        const link = document.createElement('a');
        link.download = 'antonov-sentencia.png';
        link.href = canvas.toDataURL();
        link.click();
      };

      el.share.onclick = async () => {
        const blob = await (await fetch(canvas.toDataURL())).blob();
        const file = new File([blob], 'antonov.png', { type: 'image/png' });
        
        if (navigator.share) {
          await navigator.share({ files: [file] });
        } else {
          alert('Descarga la imagen para compartir.');
        }
      };

      el.size.oninput = () => {
        el.sizeLabel.textContent = el.size.value;
        render();
      };

      el.format.onchange = render;
      
      // Preview en tiempo real mientras escribes
      let typingTimer;
      el.input.oninput = () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          render();
        }, 300); // Espera 300ms después de que el usuario deje de escribir
      };

      // Enter para generar
      el.input.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          el.generate.click();
        }
      };

      render();
    }

    document.addEventListener('astro:page-load', init);
    init();
  </script>
</Layout>