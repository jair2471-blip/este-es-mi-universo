---
// Si usas un layout, deja tu import aquí. Si no, quítalo.
// import Layout from '../layouts/Layout.astro';
---

<div class="antonov-shell">
  <div class="scanlines"></div>
  
  <div class="main-frame">
    <header class="header">
      <h1 class="glitch-title" data-text="ANTONOV">ANTONOV</h1>
      <p class="subtitle">SISTEMA DE CORRECCIÓN DE MENTALIDAD</p>
    </header>

    <div class="terminal-body">
      <div class="canvas-container">
        <canvas id="mainCanvas"></canvas>
      </div>

      <div class="ui-controls">
        <div class="input-area">
          <label>INGRESA TU EXCUSA O MIEDO:</label>
          <textarea id="userInput" placeholder="Escribe aquí..."></textarea>
        </div>

        <div class="button-grid">
          <button id="btnExecute" class="btn-main">EJECUTAR PROTOCOLO</button>
          <button id="btnDownload">DESCARGAR</button>
          <select id="aspectRatio">
            <option value="1">POST (1:1)</option>
            <option value="1.77">STORY (9:16)</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  :root { --gold: #ffd700; --dark: #050505; }
  
  .antonov-shell {
    background: var(--dark);
    color: white;
    min-height: 100vh;
    font-family: 'Courier New', Courier, monospace;
    display: flex;
    justify-content: center;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  /* Efecto de líneas de monitor viejo */
  .scanlines {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    background-size: 100% 4px, 3px 100%;
    pointer-events: none; z-index: 10;
  }

  .main-frame { width: 100%; max-width: 800px; z-index: 5; }

  .header { text-align: center; margin-bottom: 2rem; }
  .glitch-title { font-size: 4rem; font-weight: 900; letter-spacing: 10px; color: var(--gold); margin: 0; }

  .canvas-container { 
    background: #000; border: 2px solid #222; 
    display: flex; justify-content: center; margin-bottom: 1.5rem;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
  }
  
  canvas { max-width: 100%; height: auto; }

  .ui-controls { background: #111; padding: 20px; border: 1px solid #333; }
  
  textarea {
    width: 100%; background: #000; color: #fff; border: 1px solid #444;
    padding: 15px; margin-top: 10px; font-family: sans-serif; resize: none;
  }

  .button-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-top: 15px; }

  button, select {
    background: #222; color: #fff; border: 1px solid #444; 
    padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase;
  }

  .btn-main { background: var(--gold); color: #000; border: none; }
  button:hover { filter: brightness(1.2); }

  @media (max-width: 600px) {
    .button-grid { grid-template-columns: 1fr; }
    .glitch-title { font-size: 2.5rem; }
  }
</style>

<script is:inline>
  // Encapsulamos todo para evitar fugas de memoria y errores de cierre
  (function() {
    const canvas = document.getElementById('mainCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const input = document.getElementById('userInput');
    const btnExecute = document.getElementById('btnExecute');
    const aspectRatioSelect = document.getElementById('aspectRatio');
    
    let currentText = "SISTEMA LISTO PARA EJECUCIÓN";

    function draw(text = currentText) {
      const w = canvas.width;
      const h = canvas.height;

      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, w, h);

      ctx.strokeStyle = '#ffd700';
      ctx.lineWidth = 40;
      ctx.strokeRect(0, 0, w, h);

      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.font = '900 70px sans-serif'; 
      
      const words = text.split(' ');
      let line = '';
      let y = h / 2 - ((words.length / 3) * 50);
      
      for(let n = 0; n < words.length; n++) {
        let testLine = line + words[n] + ' ';
        let metrics = ctx.measureText(testLine);
        if (metrics.width > w * 0.8 && n > 0) {
          ctx.fillText(line, w/2, y);
          line = words[n] + ' ';
          y += 90;
        } else {
          line = testLine;
        }
      }
      ctx.fillText(line, w/2, y);
      
      ctx.fillStyle = '#ffd700';
      ctx.font = 'bold 25px monospace';
      ctx.fillText('ANTONOV // ELITE MINDSET', w/2, h - 80);
    }

    function initCanvas() {
      const ratio = parseFloat(aspectRatioSelect.value) || 1;
      canvas.width = 1080;
      canvas.height = 1080 * ratio;
      draw();
    }

    function glitchAnimate(targetText) {
      let iteration = 0;
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789#%&@$";
      const interval = setInterval(() => {
        const gText = targetText.split('').map((char, index) => {
          if(index < iteration) return targetText[index];
          if(targetText[index] === " ") return " ";
          return chars[Math.floor(Math.random() * chars.length)];
        }).join('');
        
        draw(gText);
        iteration += 0.5;
        if(iteration >= targetText.length) {
          clearInterval(interval);
          draw(targetText);
        }
      }, 30);
    }

    btnExecute.addEventListener('click', async () => {
      const val = input.value.trim();
      if(!val) return;
      
      btnExecute.innerText = "HACKEANDO EXCUSA...";
      
      try {
        const response = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: `Eres Antonov. El usuario dice: "${val}". Responde con una frase de máximo 12 palabras, brutal, directa y en mayúsculas.` })
        });
        const data = await response.json();
        currentText = data.text.toUpperCase();
        glitchAnimate(currentText);
      } catch (e) {
        currentText = "ERROR DE CONEXIÓN";
        draw();
      }
      btnExecute.innerText = "EJECUTAR PROTOCOLO";
    });

    document.getElementById('btnDownload').onclick = () => {
      const link = document.createElement('a');
      link.download = `ANTONOV_${Date.now()}.png`;
      link.href = canvas.toDataURL();
      link.click();
    };

    aspectRatioSelect.onchange = initCanvas;

    // Ejecución inicial
    initCanvas();
  })();
</script>