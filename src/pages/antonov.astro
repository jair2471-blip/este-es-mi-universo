---
import Layout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'ANTONOV | EL NÚCLEO',
  description: 'Sistema de decodificación de realidad.',
};
---

<Layout metadata={metadata}>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=JetBrains+Mono:wght@400;700&display=swap');

    :root {
      --accent: #ffd700;
      --border-color: #333;
    }

    :global(main) { width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }

    .master-wrapper {
      width: 100%;
      height: 100vh;
      background: #050505;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      color: white;
      font-family: 'Inter', sans-serif;
    }

    .app-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      width: 95%;
      max-width: 1300px;
      height: 85vh;
      background: #000;
      border: 1px solid var(--border-color);
      box-shadow: 0 0 50px rgba(0,0,0,1);
    }

    .sidebar {
      background: #080808;
      padding: 35px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .brand-area h1 { font-weight: 900; font-size: 2.8rem; color: #fff; margin: 0; letter-spacing: -2px; line-height: 1; }
    
    .input-group { margin-top: 30px; }
    .input-group label { font-family: 'JetBrains Mono'; font-size: 10px; color: #666; display: block; margin-bottom: 8px; text-transform: uppercase; }

    textarea {
      background: #111; border: 1px solid #333; color: #fff; padding: 15px;
      font-size: 14px; width: 100%; height: 120px; resize: none; 
      font-family: 'Inter', sans-serif;
    }

    .btn-main {
      background: #fff; color: #000; border: none; padding: 20px;
      font-weight: 900; text-transform: uppercase; cursor: pointer; width: 100%;
      transition: 0.3s; font-family: 'Inter';
    }
    .btn-main:hover { background: var(--accent); }

    .canvas-area {
      background: #080808;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      overflow: hidden;
    }

    #mainCanvas {
      max-width: 100%;
      max-height: 100%;
      aspect-ratio: 1/1;
      border: 1px solid #222;
      background: #000;
    }

    @media (max-width: 1100px) {
      .app-container { grid-template-columns: 1fr; height: auto; overflow-y: auto; }
      .sidebar { border-right: none; border-bottom: 1px solid var(--border-color); }
      .canvas-area { height: 60vh; }
    }
  </style>

  <div class="master-wrapper">
    <div class="app-container">
      <aside class="sidebar">
        <div class="brand-area">
          <h1>ANTONOV</h1>
          <p style="color: var(--accent); font-family: 'JetBrains Mono'; font-size: 10px; letter-spacing: 3px; margin: 10px 0 0 0;">V.6.0_PROTOCOLO</p>
          
          <div class="input-group">
            <label>Inyección de Pensamiento</label>
            <textarea id="userInput" placeholder="¿Qué quieres procesar?"></textarea>
          </div>
        </div>

        <div>
          <div style="margin-bottom: 25px;">
            <label style="font-family: 'JetBrains Mono'; font-size: 10px; color: #666; display: block; margin-bottom: 8px;">ZOOM DE RESPUESTA</label>
            <input type="range" id="sizeSlider" min="40" max="140" value="85" style="width:100%; accent-color:var(--accent);">
          </div>
          <button id="generateBtn" class="btn-main">Analizar Realidad</button>
        </div>
      </aside>

      <main class="canvas-area">
        <canvas id="mainCanvas"></canvas>
      </main>
    </div>
  </div>

  <script is:inline>
    (function() {
      const init = () => {
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas?.getContext('2d');
        const btn = document.getElementById('generateBtn');
        const input = document.getElementById('userInput');
        const slider = document.getElementById('sizeSlider');

        if (!canvas || !ctx) return;

        let userQuestion = "";
        let antonovResponse = "SISTEMA LISTO PARA DECODIFICAR";

        const render = () => {
          canvas.width = 1080;
          canvas.height = 1080;

          // Fondo
          ctx.fillStyle = '#000000';
          ctx.fillRect(0, 0, 1080, 1080);

          // Grid
          ctx.strokeStyle = '#111';
          ctx.lineWidth = 1;
          for(let i=0; i<=1080; i+=108) {
            ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,1080); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(1080,i); ctx.stroke();
          }

          // 1. INPUT (ARRIBA)
          if(userQuestion) {
            ctx.font = "700 24px 'JetBrains Mono'";
            ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
            ctx.textAlign = "left";
            ctx.fillText("> INPUT: " + userQuestion.toUpperCase(), 80, 100);
          }

          // 2. SENTENCIA (CENTRO)
          const fontSize = parseInt(slider.value);
          ctx.font = `900 ${fontSize}px 'Inter'`;
          ctx.fillStyle = "white";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";

          const words = antonovResponse.toUpperCase().split(' ');
          let lines = [], line = '';
          words.forEach(w => {
            if(ctx.measureText(line + w).width < 850) line += w + ' ';
            else { lines.push(line); line = w + ' '; }
          });
          lines.push(line);

          let startY = 540 - ((lines.length - 1) * fontSize * 0.6);
          lines.forEach(l => {
            ctx.fillText(l.trim(), 540, startY);
            startY += fontSize * 1.15;
          });

          // 3. FIRMA (ABAJO)
          ctx.font = "700 20px 'JetBrains Mono'";
          ctx.fillStyle = "#ffd700";
          ctx.textAlign = "center";
          ctx.letterSpacing = "10px";
          ctx.fillText("ANTONOV // PROTOCOLO DE VERDAD", 540, 950);
          
          ctx.strokeStyle = '#ffd700';
          ctx.lineWidth = 2;
          ctx.beginPath(); ctx.moveTo(390, 975); ctx.lineTo(690, 975); ctx.stroke();
        };

        btn.onclick = async () => {
          const val = input.value.trim();
          if(!val) return;
          
          btn.innerText = "DECODIFICANDO...";
          btn.disabled = true;
          userQuestion = val;

          try {
            const res = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
  prompt: `ANTONOV HABLA CLARO, COMO VECINO DE BARRIO CON CALLE.
EL USUARIO DICE: "${val}".
SOLO ANALIZA LO QUE PASA, SIN JUZGAR NI DAR CONSEJOS.
USA PALABRAS SENCILLAS Y CERCANAS.
MÁXIMO 12 PALABRAS.
TODO EN MAYÚSCULAS.`
});


            const data = await res.json();
            antonovResponse = data.text || "SILENCIO_SISTEMA";
          } catch(e) {
            antonovResponse = "ERROR_CONEXIÓN_NÚCLEO";
          } finally {
            btn.innerText = "ANALIZAR REALIDAD";
            btn.disabled = false;
            render();
          }
        };

        slider.oninput = render;
        render();
      };

      window.onload = init;
      document.addEventListener('astro:page-load', init);
    })();
  </script>
</Layout>
