---
import Layout from '~/layouts/PageLayout.astro';

const metadata = {
  title: 'ANTONOV | EL NÚCLEO',
  description: 'Sistema de decodificación de realidad.',
};
---

<Layout metadata={metadata}>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@900&family=JetBrains+Mono:wght@400;700&display=swap');

    :root {
      --accent: #ffd700;
      --border-color: #333;
    }

    :global(main) {
      width: 100% !important;
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }

    .master-wrapper {
      width: 100%;
      height: 100vh;
      background: #050505;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: 'Inter', sans-serif;
    }

    .app-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      width: 95%;
      max-width: 1300px;
      height: 85vh;
      background: #000;
      border: 1px solid var(--border-color);
    }

    .sidebar {
      background: #080808;
      padding: 35px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    textarea {
      background: #111;
      border: 1px solid #333;
      color: #fff;
      padding: 15px;
      width: 100%;
      height: 120px;
      resize: none;
    }

    .btn-main {
      background: #fff;
      color: #000;
      border: none;
      padding: 20px;
      font-weight: 900;
      cursor: pointer;
      width: 100%;
    }

    .canvas-area {
      background: #080808;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    #mainCanvas {
      max-width: 100%;
      aspect-ratio: 1/1;
      background: #000;
    }
  </style>

  <div class="master-wrapper">
    <div class="app-container">
      <aside class="sidebar">
        <div>
          <h1>ANTONOV</h1>
          <p style="color: var(--accent); font-family: JetBrains Mono; font-size: 10px;">
            PROTOCOLO DE VERDAD
          </p>

          <textarea
            id="userInput"
            placeholder="UNA PALABRA, UNA FRASE, O UN ESTADO"
          ></textarea>
        </div>

        <button id="generateBtn" class="btn-main">ANALIZAR REALIDAD</button>
      </aside>

      <main class="canvas-area">
        <canvas id="mainCanvas"></canvas>
      </main>
    </div>
  </div>

  <script is:inline>
    function init() {
      const canvas = document.getElementById('mainCanvas');
      const ctx = canvas.getContext('2d');
      const btn = document.getElementById('generateBtn');
      const input = document.getElementById('userInput');

      let estado = "";
      let respuesta = "SISTEMA LISTO";

      function render() {
        canvas.width = 1080;
        canvas.height = 1080;

        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, 1080, 1080);

        if (estado) {
          ctx.font = "700 24px 'JetBrains Mono'";
          ctx.fillStyle = "rgba(255,215,0,0.5)";
          ctx.textAlign = "left";
          ctx.fillText("> ESTADO: " + estado.toUpperCase(), 80, 100);
        }

        ctx.font = "900 90px 'Inter'";
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        const words = respuesta.split(" ");
        let lines = [];
        let line = "";

        words.forEach(w => {
          if (ctx.measureText(line + w).width < 850) {
            line += w + " ";
          } else {
            lines.push(line);
            line = w + " ";
          }
        });
        lines.push(line);

        let y = 540 - (lines.length * 45);
        lines.forEach(l => {
          ctx.fillText(l.trim(), 540, y);
          y += 100;
        });

        ctx.font = "700 18px 'JetBrains Mono'";
        ctx.fillStyle = "#ffd700";
        ctx.fillText("ANTONOV // PROTOCOLO DE VERDAD", 540, 980);
      }

      btn.onclick = async () => {
        const val = input.value.trim();
        if (!val) return;

        btn.disabled = true;
        btn.innerText = "DECODIFICANDO...";
        estado = val;

        try {
          const res = await fetch('https://mis-frases.poderparatriunfar.workers.dev/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prompt: `
ANTONOV ES UNA VOZ DE CALLE TRANQUILA Y LÚCIDA.
NO DA CONSEJOS. NO JUZGA. NO MOTIVA.

OBSERVA Y NOMBRA.

FRASE ÚNICA.
MÁXIMO 12 PALABRAS.
TODO EN MAYÚSCULAS.

ESTADO:
"${val}"
              `
            })
          });

          const data = await res.json();
          respuesta = data.text || "SILENCIO";

        } catch (e) {
          respuesta = "ERROR DEL SISTEMA";
        } finally {
          btn.disabled = false;
          btn.innerText = "ANALIZAR REALIDAD";
          render();
        }
      };

      render();
    }

    window.onload = init;
    document.addEventListener('astro:page-load', init);
  </script>
</Layout>
